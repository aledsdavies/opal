# Devcmd Development Commands
# Multi-module project with clean separation of concerns

# =============================================================================
# PROJECT CONFIGURATION
# =============================================================================

var PROJECT = "devcmd"
var VERSION = "$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')"
var BUILD_TIME = "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
var GO_VERSION = "1.24.3"

# =============================================================================
# ğŸš€ CORE DEVELOPMENT COMMANDS
# =============================================================================

# Build the CLI from multi-module structure
build: {
    echo "ğŸ”¨ Building @var(PROJECT) CLI..."
    @workdir("cli") { go build -ldflags="-s -w -X main.Version=@var(VERSION) -X main.BuildTime=@var(BUILD_TIME)" -o ../@var(PROJECT) ./main.go }
    echo "âœ… Built: ./@var(PROJECT)"
}

# Quick setup for new contributors
setup: {
    echo "ğŸ”§ Setting up @var(PROJECT) development environment..."
    echo "ğŸ“¦ Downloading Go dependencies for all modules..."
    @parallel {
        @workdir("core") { go mod download }
        @workdir("runtime") { go mod download }
        @workdir("testing") { go mod download }
        @workdir("cli") { go mod download }
    }
    echo "Setup complete! Run dev test to verify."
}

# =============================================================================
# ğŸ§ª TESTING COMMANDS
# =============================================================================

# Fast checks for quick feedback
test-quick: {
    echo "âš¡ Running quick checks..."
    echo "ğŸ” Checking Go formatting..."
    command -v gofumpt >/dev/null 2>&1 && gofumpt -l . | head -20 || go fmt ./core/... ./runtime/... ./testing/... ./cli/... >/dev/null
    echo "ğŸ” Running basic linters..."
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run ./core/... ./runtime/... ./testing/... ./cli/... || echo "âš ï¸  golangci-lint not available"
    echo "âœ… Quick checks passed!"
}

# Comprehensive testing across all modules
test: {
    echo "ğŸ§ª Running tests across all modules..."
    @parallel {
        @workdir("core") { go test ./... }
        @workdir("runtime") { go test ./... }
        @workdir("testing") { go test ./... }
        @workdir("cli") { go test ./... }
    }
    echo "âœ… All module tests passed!"
}

# Testing with coverage reports
test-coverage: {
    echo "ğŸ“Š Running tests with coverage across all modules..."
    @workdir("core") { go test -race -coverprofile=../coverage-core.out -covermode=atomic ./... }
    @workdir("runtime") { go test -race -coverprofile=../coverage-runtime.out -covermode=atomic ./... }
    @workdir("testing") { go test -race -coverprofile=../coverage-testing.out -covermode=atomic ./... }
    @workdir("cli") { go test -race -coverprofile=../coverage-cli.out -covermode=atomic ./... }
    @cmd(coverage-reports)
}

# Generate coverage reports (only called if tests pass)
coverage-reports: {
    echo "ğŸ“Š Merging coverage reports..."
    command -v gocovmerge >/dev/null 2>&1 && gocovmerge coverage-*.out > coverage.out && rm coverage-*.out || echo "âš ï¸  gocovmerge not available"
    command -v go >/dev/null 2>&1 && go tool cover -html=coverage.out -o coverage.html && echo "ğŸ“Š Coverage report: coverage.html"
    echo "âœ… Coverage testing complete!"
}

# Test command to verify error propagation
test-error-propagation: @workdir("testing") { 
    echo "About to run a command that should fail..."
    false
    echo "This should NOT be printed if error propagation works"
}

# Module-specific testing commands
test-core: @workdir("core") { go test -v ./... }
test-runtime: @workdir("runtime") { go test -v ./... }
test-testing: @workdir("testing") { go test -v ./... }
test-cli: @workdir("cli") { go test -v ./... }

# Component-specific tests
test-lexer: @workdir("cli") { go test -v ./internal/lexer }
test-parser: @workdir("cli") { go test -v ./internal/parser }
test-engine: @workdir("cli") { go test -v ./internal/engine }
test-decorators: @parallel {
    @workdir("runtime") { go test -v ./decorators }
    @workdir("cli") { go test -v ./internal/builtins }
}

# =============================================================================
# ğŸ“ CODE QUALITY
# =============================================================================

# Format all code across modules
format: {
    echo "ğŸ“ Formatting all code across modules..."
    @parallel {
        command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./core/... ./runtime/... ./testing/... ./cli/...
        command -v nixpkgs-fmt >/dev/null 2>&1 && find . -name '*.nix' -exec nixpkgs-fmt {} + || echo "âš ï¸  nixpkgs-fmt not available"
    }
    echo "âœ… All code formatted!"
}

# Run linters across all modules
lint: {
    echo "ğŸ” Running linters across all modules..."
    if command -v golangci-lint >/dev/null 2>&1; then echo "Using golangci-lint"; else echo "âš ï¸  golangci-lint not available, using go vet"; fi
    @parallel {
        @workdir("core") { command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./... }
        @workdir("runtime") { command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./... }
        @workdir("testing") { command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./... }
        @workdir("cli") { command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./... }
    }
    echo "âœ… Linting complete!"
}

# Clean build artifacts and caches
clean: {
    echo "ğŸ§¹ Cleaning generated files and artifacts..."
    rm -f @var(PROJECT) coverage-core.out coverage-runtime.out coverage-testing.out coverage-cli.out coverage.out coverage.html
    rm -rf result result-* build/ artifacts/
    go clean -cache -modcache -testcache 2>/dev/null || echo "Go clean completed"
    echo "âœ… Cleanup complete"
}

# Update Go dependencies across all modules
update-packages: {
    echo "ğŸ”„ Updating Go dependencies across all modules..."
    
    @parallel {
        @workdir("core") {
            echo "ğŸ“¦ Updating core module dependencies..."
            go get -u ./...
            go mod tidy
            echo "âœ… Core module updated"
        }
        @workdir("runtime") {
            echo "ğŸ“¦ Updating runtime module dependencies..."
            go get -u ./...
            go mod tidy
            echo "âœ… Runtime module updated"
        }
        @workdir("testing") {
            echo "ğŸ“¦ Updating testing module dependencies..."
            go get -u ./...
            go mod tidy
            echo "âœ… Testing module updated"
        }
        @workdir("cli") {
            echo "ğŸ“¦ Updating CLI module dependencies..."
            go get -u ./...
            go mod tidy
            echo "âœ… CLI module updated"
        }
    }
    
    echo ""
    echo "ğŸ”„ Syncing workspace..."
    go work sync
    
    echo "âœ… All modules updated successfully!"
    echo "ğŸ’¡ Consider running 'devcmd run test' to verify everything works"
}

# =============================================================================
# ğŸ“¦ NIX INTEGRATION  
# =============================================================================

# Build with Nix
nix-build: {
    echo "ğŸ“¦ Building with Nix..."
    nix build .#@var(PROJECT) --print-build-logs
    echo "âœ… Nix build complete"
}

# Comprehensive Nix validation
nix-check: {
    echo "ğŸ” Running comprehensive Nix validation..."
    nix flake check --print-build-logs
    echo "âœ… Nix validation passed"
}

# Test all example CLIs
test-examples: {
    echo "ğŸ¯ Testing example CLIs..."
    @parallel {
        nix build .#basicDev --print-build-logs
        nix build .#webDev --print-build-logs
        nix build .#goProject --print-build-logs
    }
    echo "Testing example functionality..."
    @parallel {
        nix run .#basicDev -- --help >/dev/null
        nix run .#webDev -- --help >/dev/null
        nix run .#goProject -- --help >/dev/null
    }
    echo "âœ… Example CLI tests passed!"
}

# =============================================================================
# ğŸ”„ DEVELOPMENT WORKFLOWS
# =============================================================================

# Fast development iteration
dev-flow: {
    echo "ğŸ”„ Running development workflow..."
    dev test-quick
    dev test
    dev build
    echo "âœ… Development workflow complete!"
}

# Full CI workflow (mirrors GitHub Actions)
ci: {
    echo "ğŸ”„ Running CI workflow..."
    echo "Stage 1: Quick Checks..."
    @cmd(test-quick)
    echo "Stage 2: Full Testing..."
    @cmd(test-coverage)
    echo "Stage 3: Build Verification..."
    @cmd(build)
    echo "Stage 4: Nix Validation..."
    @cmd(nix-check)
    echo "ğŸ‰ CI workflow complete!"
}

# Release preparation with comprehensive testing
release: @timeout(10m) {
    echo "ğŸ“¦ Running release preparation workflow..."
    dev clean
    dev setup
    dev ci
    dev test-examples
    dev format
    echo "ğŸ“‹ Release checklist complete!"
    echo "ğŸš€ Ready for release!"
}

# =============================================================================
# ğŸ“Š PROJECT STATUS & UTILITIES
# =============================================================================

# Show detailed project information
info: {
    echo "ğŸ“Š @var(PROJECT) Multi-Module Project Status"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Project: @var(PROJECT)"
    echo "Version: @var(VERSION)"
    echo "Build time: @var(BUILD_TIME)"
    echo "Go version: @var(GO_VERSION)"
    echo ""
    echo "Module Structure:"
    echo "  core/     - AST, types, errors, and plan system"
    echo "  runtime/  - Decorator implementations and execution context"
    echo "  testing/  - Testing utilities and harnesses"
    echo "  cli/      - Main CLI application and internal packages"
    echo ""
    echo "Statistics:"
    echo "  Go source files: $(find . -name '*.go' | wc -l)"
    echo "  Test files: $(find . -name '*_test.go' | wc -l)"
    echo "  Modules: $(find . -name 'go.mod' | wc -l)"
    echo ""
    echo "Git status:"
    git status --porcelain | head -5 || echo "Not a git repository"
}

# Quick alias for info
status: dev info

# =============================================================================
# ğŸ“‹ HELP & DOCUMENTATION
# =============================================================================

# Show comprehensive help
help: {
    echo "ğŸ”§ Devcmd Multi-Module Development Commands"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸš€ Core Development:"
    echo "  setup          - Set up development environment"
    echo "  build          - Build the CLI binary"
    echo "  clean          - Clean artifacts and caches"
    echo ""
    echo "ğŸ§ª Testing (ordered by speed):"
    echo "  test-quick     - Fast checks and linting"
    echo "  test           - Run all module tests"
    echo "  test-coverage  - Tests with coverage reports"
    echo "  test-core      - Test core module only"
    echo "  test-runtime   - Test runtime module only"
    echo "  test-testing   - Test testing module only"
    echo "  test-cli       - Test CLI module only"
    echo ""
    echo "ğŸ“ Code Quality:"
    echo "  format         - Format all code"
    echo "  lint           - Run all linters"
    echo ""
    echo "ğŸ”„ Package Management:"
    echo "  update-packages - Update Go dependencies across all modules"
    echo ""
    echo "ğŸ“¦ Nix Integration:"
    echo "  nix-build      - Build with Nix"
    echo "  nix-check      - Comprehensive Nix validation"
    echo "  test-examples  - Test example CLIs"
    echo ""
    echo "ğŸ”„ Workflows:"
    echo "  dev-flow       - Fast development iteration"
    echo "  ci             - Full CI workflow"
    echo "  release        - Release preparation"
    echo ""
    echo "ğŸ“Š Utilities:"
    echo "  info           - Show project status"
    echo "  status         - Show project status (alias)"
    echo "  help           - Show this help"
    echo ""
    echo "Multi-module structure: core, runtime, testing, cli"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}